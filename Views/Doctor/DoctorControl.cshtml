@using Azure.Core
@using LMDH_QS.ViewModel
@model DoctorDashboardViewModel

@{
    ViewData["Title"] = "Doctor Dashboard";
}

<div class="container-fluid py-4">

    <h2 class="mb-4 text-primary fw-bold text-center">Doctor's Patient Monitoring</h2>

   <!-- Tabs -->
    <ul class="nav nav-tabs" id="doctorTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queueTab"
                    type="button" role="tab" aria-controls="queueTab" aria-selected="true">
                <i class="bi bi-clock-history me-1"></i> Today's Patient Queue
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#historyTab"
                    type="button" role="tab" aria-controls="historyTab" aria-selected="false">
                <i class="bi bi-archive me-1"></i> Backtrack Records
            </button>
        </li>
    </ul>




    <!-- Tab Content -->
    <div class="tab-content" id="doctorTabsContent">

        <!-- Queue Tab -->
        <div class="tab-pane fade show active" id="queueTab" role="tabpanel" aria-labelledby="queue-tab">
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-success text-white text-center fw-semibold"> <i class="bi bi-clock-history me-2"></i> Today's Patient Queue Status </div>
                <div class="card-body p-0">
                    <table class="table table-hover text-center align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Department</th>
                                <th>Ticket No</th>
                                <th>Patient Name</th>
                                <th>Check-in Time</th>
                                <th>Status</th>
                                <th>Add Diagnosis & Prescriptions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var q in Model.TodayQueue)
                            {
                                <tr class="@(q.Status switch {
                                    "Serving" => "bg-warning bg-opacity-25",
                                    "Done" => "bg-info bg-opacity-25",
                                    "Consultation Standby" => "bg-success bg-opacity-25 text-dark",
                                    "Skipped" => "bg-danger bg-opacity-25",
                                    _ => ""
                                })">
                                    <td>@q.Department</td>
                                    <td><strong>@($"{q.DeptCode}{q.QueueNumber:D3}")</strong></td>
                                    <td>@q.PatientName</td>
                                    <td>@q.VisitTime.ToString(@"hh\:mm")</td>
                                    <td><span class="badge text-dark bg-@(q.Status.ToLower())">@q.Status</span></td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#diagnosisModal"
                                                data-id="@q.PatientIdentification"
                                                data-name="@q.PatientName"
                                                data-visit-date="@q.VisitDate.ToString("yyyy-MM-dd")">
                                            Add Note
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-pane fade" id="historyTab" role="tabpanel" aria-labelledby="history-tab">
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-primary text-white text-center fw-semibold"> <i class="bi bi-archive me-2"></i> Backtrack Patient Records </div>
                <div class="card-body">
                  @*   <form method="get" class="row g-3 mb-3">
                        <div class="col-md-6">
                            <input type="text" name="search" class="form-control" 
                                   value="@Context.Request.Query["search"].ToString()"
                                   placeholder="Search by Name, Ticket No, or Dept..." />
                        </div>
                        <div class="col-md-4">
                            <input type="date" name="date" class="form-control" 
                                   value="@Context.Request.Query["date"].ToString()" />
                        </div>
                        <div class="col-md-2 d-grid">
                            <button type="submit" class="btn btn-outline-primary">Search</button>
                        </div>
                    </form> *@

                   <form id="backtrackForm" class="row g-3 mb-3">
                        <div class="col-md-6">
                            <input type="text" name="search" id="searchInput" placeholder="Search patient..." class="form-control" />
                        </div>
                        <div class="col-md-4">
                            <input type="date" name="date" id="dateInput" class="form-control" />
                        </div>
                        <div class="col-md-2 d-grid">
                            <button type="submit" class="btn btn-primary">Search</button>
                        </div>
                    </form>

                   
                    
                    <table class="table table-bordered table-striped text-center align-middle">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Department</th>
                                <th>Ticket</th>
                                <th>Patient</th>
                                <th>Status</th>
                                <th>Doctor's Note</th>
                            </tr>
                        </thead>
                        <tbody id="backtrackTableContainer">
                            @await Html.PartialAsync("_BacktrackTable", Model.History)
                        </tbody>
                    </table>

                    <div >
                        
                    </div>

                    
                </div>
            </div>
        </div>

    </div> <!-- End Tab Content -->

</div>

<!-- Diagnosis & Patient vitals Modal -->
<div class="modal fade" id="diagnosisModal" tabindex="-1" aria-labelledby="diagnosisModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
       <form id="diagnosisForm" method="post" asp-action="SaveDoctorNote">

            <!-- Hidden Fields -->
            <input type="hidden" id="PatientId" name="PatientIdentification" />
            <input type="hidden" id="VisitDate" name="VisitDate" />
            <input type="hidden" id="HiddenPatientName" name="PatientName" />

            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title">Patient Case Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Patient Name</label>
                        <input type="text" id="PatientName" class="form-control" disabled />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Visit Date</label>
                        <input type="text" id="VisitDateDisplay" class="form-control" disabled />
                    </div>
                </div>

                <!-- 🔹 Vital Signs in One Row -->
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label for="bp" class="form-label">BP</label>
                        <input type="text" class="form-control" id="bp" name="BP" required>
                    </div>
                    <div class="col-md-2">
                        <label for="cr" class="form-label">CR</label>
                        <input type="number" class="form-control" id="cr" name="CR" required>
                    </div>
                    <div class="col-md-2">
                        <label for="pr" class="form-label">PR</label>
                        <input type="number" class="form-control" id="pr" name="PR" required>
                    </div>
                    <div class="col-md-3">
                        <label for="temp" class="form-label">Temp (°C)</label>
                        <input type="number" step="0.1" class="form-control" id="temp" name="Temp" required>
                    </div>
                    <div class="col-md-3">
                        <label for="weight" class="form-label">Weight (kg)</label>
                        <input type="number" step="0.1" class="form-control" id="weight" name="Weight" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">History / Present Illness</label>
                    <textarea class="form-control" name="HistoryOfIllness" rows="3" required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Diagnosis</label>
                    <textarea class="form-control" name="Diagnosis" rows="3" required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Remarks</label>
                    <textarea class="form-control" name="Remarks" rows="3" required></textarea>
                </div>

                <!-- Doctor Name -->
                <div class="mb-3">
                    <label class="form-label">Doctor’s Name</label>
                    <input type="text" class="form-control" name="DoctorName" value="@User.Identity.Name" readonly />
                </div>

                <!-- Discharge Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Date of Discharge (OPD)</label>
                        <input type="date" class="form-control" name="DischargeDate" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Time of Discharge (OPD)</label>
                        <input type="time" class="form-control" name="DischargeTime" required />
                    </div>
                </div>

                <!-- Disposition -->
                <div class="mb-3">
                    <label class="form-label">Disposition</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Disposition" value="Treated and Sent Home" id="disp1">
                        <label class="form-check-label" for="disp1">Treated and Sent Home</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Disposition" value="For Admission" id="disp2">
                        <label class="form-check-label" for="disp2">For Admission</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Disposition" value="Refused Admission" id="disp3">
                        <label class="form-check-label" for="disp3">Refused Admission</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Disposition" value="Referred" id="disp4">
                        <label class="form-check-label" for="disp4">Referred</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Disposition" value="Out When Called" id="disp5">
                        <label class="form-check-label" for="disp5">Out When Called</label>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>

        </form>


    </div>
  </div>
</div>


<!-- View Diagnosis Modal -->
<div class="modal fade" id="viewDiagnosisModal" tabindex="-1" aria-labelledby="viewDiagnosisLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="viewDiagnosisLabel">Doctor's Note (View Only)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Patient Name</label>
            <input type="text" id="ViewPatientName" class="form-control" disabled />
          </div>
          <div class="col-md-6">
            <label class="form-label">Visit Date</label>
            <input type="text" id="ViewVisitDate" class="form-control" disabled />
          </div>
        </div>

        <!-- Vital Signs -->
        <div class="row mb-3">
          <div class="col-md-2">
            <label class="form-label">BP</label>
            <input type="text" id="ViewBP" class="form-control" disabled />
          </div>
          <div class="col-md-2">
            <label class="form-label">CR</label>
            <input type="text" id="ViewCR" class="form-control" disabled />
          </div>
          <div class="col-md-2">
            <label class="form-label">PR</label>
            <input type="text" id="ViewPR" class="form-control" disabled />
          </div>
          <div class="col-md-3">
            <label class="form-label">Temp (°C)</label>
            <input type="text" id="ViewTemp" class="form-control" disabled />
          </div>
          <div class="col-md-3">
            <label class="form-label">Weight (kg)</label>
            <input type="text" id="ViewWeight" class="form-control" disabled />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">History / Present Illness</label>
          <textarea id="ViewHistory" class="form-control" rows="3" disabled></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Diagnosis</label>
          <textarea id="ViewDiagnosis" class="form-control" rows="3" disabled></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Remarks</label>
          <textarea id="ViewRemarks" class="form-control" rows="3" disabled></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Doctor’s Name</label>
          <input type="text" id="ViewDoctorName" class="form-control" disabled />
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Date of Discharge (OPD)</label>
            <input type="text" id="ViewDischargeDate" class="form-control" disabled />
          </div>
          <div class="col-md-6">
            <label class="form-label">Time of Discharge (OPD)</label>
            <input type="text" id="ViewDischargeTime" class="form-control" disabled />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Disposition</label>
          <input type="text" id="ViewDisposition" class="form-control" disabled />
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>



 @section Scripts
{

    <script>

        const diagnosisModal = document.getElementById('diagnosisModal');
        const viewDiagnosisModal = document.getElementById('viewDiagnosisModal');

        diagnosisModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;

            const patientId = button.getAttribute('data-id');
            const patientName = button.getAttribute('data-name');
            const visitDate = button.getAttribute('data-visit-date'); // yyyy-MM-dd

            // Assign to hidden inputs
            document.getElementById('PatientId').value = patientId;
            document.getElementById('VisitDate').value = visitDate;
            document.getElementById('HiddenPatientName').value = patientName;

            // Display readable values in disabled inputs
            document.getElementById('PatientName').value = patientName;

            // Format visit date to "MMM dd, yyyy" (e.g., Jul 18, 2025)
            const formattedDate = new Date(visitDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: '2-digit'
            });

            document.getElementById('VisitDateDisplay').value = formattedDate;

          

        });


       $(document).ready(function () {
            $("#backtrackForm").on("submit", function (e) {
                e.preventDefault(); // 🔹 stop full page reload

                $.get("/Doctor/BacktrackPartial", { 
                    search: $("#searchInput").val(), 
                    date: $("#dateInput").val() 
                })
                .done(function (data) {
                    $("#backtrackTableContainer").html(data); // update tbody only
                })
                .fail(function (xhr) {
                    alert("Error: " + xhr.status + " - " + xhr.statusText);
                });
            });
        });


        @if (TempData["DoctorNoteSuccess"] != null)
        {
            <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: @Json.Serialize(TempData["DoctorNoteSuccess"]),
                    confirmButtonColor: '#3085d6'
                });
            </text>
        }

        else if (TempData["DoctorNoteError"] != null)
        {
            <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: '@TempData["DoctorNoteError"]',
                    confirmButtonColor: '#d33'
                });
            </text>
        }

       
        //This is for viewing of doctor's note per patient
        viewDiagnosisModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const patientId = button.getAttribute('data-id');
            const visitDate = button.getAttribute('data-visitdate');

            console.log(`${patientId} ${visitDate}`)

            fetch(`/Doctor/GetDoctorNote?patientId=${encodeURIComponent(patientId)}&visitDate=${encodeURIComponent(visitDate)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('ViewPatientName').value = data.patientName;
                        document.getElementById('ViewVisitDate').value = data.visitDate;

                        document.getElementById('ViewBP').value = data.bp || '';
                        document.getElementById('ViewCR').value = data.cr || '';
                        document.getElementById('ViewPR').value = data.pr || '';
                        document.getElementById('ViewTemp').value = data.temp || '';
                        document.getElementById('ViewWeight').value = data.weight || '';

                        document.getElementById('ViewHistory').value = data.history || '';
                        document.getElementById('ViewDiagnosis').value = data.diagnosis || '';
                        document.getElementById('ViewRemarks').value = data.remarks || '';
                        document.getElementById('ViewDoctorName').value = data.doctorName || '';

                        document.getElementById('ViewDischargeDate').value = data.dischargeDate || '';
                        document.getElementById('ViewDischargeTime').value = data.dischargeTime || '';
                        document.getElementById('ViewDisposition').value = data.disposition || '';
                    } else {
                        alert(data.message || "No data found.");
                    }
                })
                .catch(error => {
                    console.error("Error loading diagnosis data:", error);
                    alert("Failed to load data.");
                });
        });


       $(document).on("click", "button[data-bs-target='#diagnosisModal']", function () {
            var patientId = $(this).data("id");
            var visitDate = $(this).data("visit-date");

            openDiagnosisModal(patientId, visitDate);
        });

    </script>

    <script>
       function openDiagnosisModal(patientId, visitDate) {
            $.get("/Doctor/GetVitals", { patientId: patientId, visitDate: visitDate }, function (data) {
                if (data.success) {
                    $("#bp").val(data.bp);
                    $("#cr").val(data.cr);
                    $("#pr").val(data.pr);
                    $("#temp").val(data.temp);
                    $("#weight").val(data.weight);
                } else {
                    console.warn("⚠️ No vitals found:", `data.message ${patientId} ${visitDate}`);
                    // clear fields or leave them empty
                    $("#bp, #cr, #pr, #temp, #weight").val("");
                }
            });

            $("#PatientId").val(patientId);
            $("#VisitDate").val(visitDate);

            const formattedDate = new Date(visitDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: '2-digit'
            });
            $("#VisitDateDisplay").val(formattedDate);

            $("#diagnosisModal").modal("show"); // ✅ correct modal ID
        }

    </script>
}