@model IEnumerable<LMDH_QS.Models.Queue>

@{
    ViewData["Title"] = "Consultation";
}

<div class="container-fluid p-4">

    <div class="d-flex flex-wrap justify-content-between align-items-center">
        <h1 class="text-dark fw-bold m-0">Consultation</h1>

        <div class="text-end">
            <h5 class="text-secondary fw-semibold mb-2">Queue Status Legend</h5>
            <ul class="list-unstyled mb-0">
                <li><span class="badge bg-warning text-dark px-3 py-1">Serving</span></li>
                <li><span class="badge bg-info text-dark px-3 py-1">Done</span></li>
                <li><span class="badge bg-success text-white px-3 py-1">Standby</span></li>
            </ul>
        </div>
    </div>

    <hr />

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Department</th>
                    <th>Check-in Time</th>
                    <th>Patient Name</th>
                    <th>Ticket No.</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="consultationQueueTable">
            </tbody>

        </table>

        <h5 class="mt-4">Missed Patients</h5>
        <table class="table table-bordered table-striped">
            <thead class="table-secondary">
                <tr>
                    <th>Department</th>
                    <th>Check-in Time</th>
                    <th>Patient Name</th>
                    <th>Ticket No.</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="missedTable">
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/queueHub")
            .build();

        // 🔁 Listen specifically for consultation queue updates
        connection.on("UpdateConsultationQueue", () => {
            fetchQueue();         // Refresh consultation table
            // fetchMissedQueue();   // Refresh missed table (if needed)
        });

        connection.start()
            .then(() => {
                console.log("SignalR connected to queueHub (Consultation)");
                fetchQueue();
                // fetchMissedQueue();
            })
            .catch(err => console.error("SignalR Error:", err));

        function fetchQueue() {
            fetch('/Staff/ConsultationQueueRows')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('consultationQueueTable').innerHTML = html;
                });
        }

        // function fetchMissedQueue() {
        //     fetch('/Staff/ConsultaionMissedList')
        //         .then(res => res.text())
        //         .then(html => {
        //             document.getElementById('missedTable').innerHTML = html;
        //         });
        // }

        // 🔁 Called when any action button is clicked (Call, Skip, Done, etc.)
        function updateStatus(patientId, action, visitDate, department) {
            let safeDateStr = visitDate.trim();

            if (safeDateStr.includes(' ')) {
                safeDateStr = safeDateStr.replace(' ', 'T');
            }
            if (safeDateStr.includes('.')) {
                safeDateStr = safeDateStr.split('.')[0];
            }

            const rawDate = new Date(safeDateStr);

            if (isNaN(rawDate.getTime())) {
                console.error("❌ Invalid visitDate after sanitization:", visitDate);
                Swal.fire("Invalid Date", "The visit date is invalid or missing.", "error");
                return;
            }

            const formattedVisitDate = rawDate.toISOString();

            sendStatusUpdate(patientId, action, formattedVisitDate, department);
        }

        function sendStatusUpdate(patientId, action, visitDate, department) {
            fetch(`/Staff/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    PatientIdentification: patientId,
                    VisitDate: visitDate,
                    Department: department
                })
            })
            .then(async res => {
                const contentType = res.headers.get('content-type');
                let data = null;

                if (contentType && contentType.includes('application/json')) {
                    data = await res.json();
                } else {
                    const text = await res.text();
                    throw new Error(`Non-JSON response: ${text}`);
                }

                if (res.ok && data.success) {
                    if (data.removeRow) {
                        const row = document.getElementById(`row-${patientId}`);
                        if (row) row.remove();
                    }

                     // 🗣️ Speak announcement if action is Call
                    if (action === 'CallForConsultation' && data.ticketNo && data.department) {
                        const utterance = new SpeechSynthesisUtterance(`For Consultation: Patient ${data.ticketNo}, please proceed to ${data.department}`);
                        utterance.lang = 'en-US';
                        utterance.rate = 0.9;
                        speechSynthesis.speak(utterance);
                    }

                    // ✅ Notify Public Display to refresh CONSULTATION TABLE only
                    connection.invoke("UpdateConsultation");

                    if (action === 'Skip') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Patient Skipped',
                            text: 'The patient has been marked as skipped.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }

                    if (action === 'Done') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Patient Sent to Doctor',
                            text: 'The patient has completed queueing and is now proceeding to consultation.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }

                    
                } else {
                    Swal.fire("Failed", data?.message || "An error occurred.", "error");
                }
            })
            .catch(err => {
                console.error(`${action} failed:`, err);
                Swal.fire("Error", err.message || "Something went wrong. Please try again.", "error");
            });
        }
    </script>
}

